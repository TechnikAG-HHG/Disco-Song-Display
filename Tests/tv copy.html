<!DOCTYPE html>
<html>


<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>my tv</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='tv.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    
</head>
<body>
        <div class="container pe-0" , id="alll">

            <div class="row" style="position:absolute; width: 100%; height: 100vh" id="test">
                <div class="col-md pe-0" style="background-color: #1C1C1C">
                    <div id="foodDiv" class="container-fluid text-center">
                        <h1 id="headi">Getränke- und Speiseliste</h1>

                        <table class="foodtable" id=tablele>

                            <tr>
                                <th colspan="3">Getränke</th>
                            </tr>

                            <tr>
                                <td>Wasser</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Cola</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Fanta</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Sprite</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Slush Eis</td>
                                <td>0.2 l</td>
                                <td>2.00 €</td>
                            </tr>

                            <tr>
                                <th colspan="3">Speisen</th>
                            </tr>

                            <tr>
                                <td>Sandwich</td>
                                <td></td>
                                <td>TBD</td>
                            </tr>
                            <tr>
                                <td>Brezeln</td>
                                <td></td>
                                <td>1.00 €</td>
                            </tr>

                            <tr>
                                <th colspan="3">Snacks</th>
                            </tr>

                            <tr>
                                <td>Salzsstangen</td>
                                <td>1 Becher</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Nüsse</td>
                                <td>1 Becher</td>
                                <td>1.00 €</td>
                            </tr>
                            <tr>
                                <td>Chips</td>
                                <td>1 Tüte</td>
                                <td>TBD</td>
                            </tr>
                            <tr>
                                <td>Popcorn</td>
                                <td>1 Tüte</td>
                                <td>TBD</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div id="currentSongCol" class="col-md pe-0" >
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                    

                    <div id="currentSongDiv" class="container-fluid text-center">
                      <div id="gradient">
                        <img id="album-art" src="{{img}}">
                        
                        <div id="currentSong" class="container songDiv">
                          <h2 id="songname" class="scrolling-text">{{ artists }}</h2>
                          <h3 id="song-artists" class="scrolling-text">{{ songname }}</h3>
                          
                          <progress id="progressbar" value="{{progress_ms_new}}" max="{{duration_ms}}"></progress>
                        </div>
                        <div id="upcoming1" class="container songDiv upcoming">
                          <h2 id="upcoming1songname" class="scrolling-text">{{ upcoming[0].name }}</h2>
                          <h3 id="upcoming1artists" class="scrolling-text">{{ upcoming[0].artists }}</h3>
                        </div>
                        
                        <div id="upcoming2" class="container songDiv upcoming">
                          <h2 id="upcoming2songname" class="scrolling-text">{{ upcoming[1].name }}</h2>
                          <h3 id="upcoming2artists" class="scrolling-text">{{ upcoming[1].artists }}</h3>
                        </div>
                        <div id="stuff">
                          <br>
                          <br>
                          {% for item in listing %}
                          <p>{{item}}</p>
                          
                          {% endfor %}
                          <br>
                        </div>
                      </div>
                    </div>
    
                          
                </div>
            </div>
        </div>

    <script>
        var ip = "<%= ip %>";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    
    <script>
      var queue;

        $(document).ready(function() {
          

          



          function refreshContent() {
            // Make an Ajax request to the server
            
            $.ajax({
              url: "/tv", // Replace with the appropriate server endpoint
              method: "GET",
              success: function(response) {
                // Create a temporary element to hold the response HTML
                var tempElement = document.createElement('div');
                tempElement.innerHTML = response;
      
                // Extract the new image URL from the response
                var newImgURL = tempElement.querySelector('#album-art').src;
                var newSongname = tempElement.querySelector('#songname').textContent;
                var newArtistname = tempElement.querySelector('#song-artists').textContent;
                var newUp1name = tempElement.querySelector('#upcoming1songname').textContent;
                var newUp1Aname = tempElement.querySelector('#upcoming1artists').textContent;
                var newUp2name = tempElement.querySelector('#upcoming2songname').textContent;
                var newUp2Aname = tempElement.querySelector('#upcoming2artists').textContent;
                var newProgress = parseFloat(tempElement.querySelector('#progressbar').value);
                
      
                // Get the existing image element
                var albumArtElement = document.querySelector('#album-art');
                var oldSongname = document.querySelector('#songname');
                var oldArtistname = document.querySelector('#song-artists');
                var oldUp1name = document.querySelector('#upcoming1songname');
                var oldUp1Aname = document.querySelector('#upcoming1artists');
                var oldUp2name = document.querySelector('#upcoming2songname');
                var oldUp2Aname = document.querySelector('#upcoming2artists');
                var oldProgress = document.querySelector('#progressbar');
                var currentSongCol = document.getElementById('currentSongCol')
                
                // Check if the new image URL is different from the existing one
                if (newImgURL !== albumArtElement.src || newUp1name !== oldUp1name.textContent || newUp2name !== oldUp2name.textContent || isFirstExecution) {
                  // Update the image URL
                  console.log("Updated:", oldUp1name.textContent);
                  albumArtElement.src = newImgURL;
                  oldSongname.textContent  = newSongname;
                  oldArtistname.textContent  = newArtistname;
                  oldUp1name.textContent  = newUp1name;
                  oldUp1Aname.textContent  = newUp1Aname;
                  oldUp1Aname.textContent  = newUp1Aname;
                  oldUp2name.textContent  = newUp2name;
                  oldUp2Aname.textContent  = newUp2Aname;
                  currentSongCol.style.backgroundImage = "url('" + newImgURL + "')"
                  isFirstExecution = false;
                  first = 0;

                }


                var scrollingTextElements = document.getElementsByClassName('scrolling-text');
                for (var i = 0; i < scrollingTextElements.length; i++) {
                  var element = scrollingTextElements[i];
                  if (element.scrollWidth > element.clientWidth) {
                    var text = element.textContent.trim();
                    var maxWidth = element.clientWidth;
                    
                    while (element.scrollWidth > maxWidth) {
                      text = text.slice(0, -1); // Remove the last character
                      element.textContent = text + '...';
                    }
                  }
                }
                
              


                
                
              

                // Clean up the temporary element
                tempElement = null;
              },
              error: function(xhr, status, error) {
                // Handle the error case
                console.log("Error:", error);
              }
            });
          }
      
          // Refresh the content initially
          refreshContent();
      
          // Refresh the content every 10 seconds
          setInterval(refreshContent, 600); // 10 seconds = 10,000 milliseconds


          var first;
          var duration_ms;
          var progress_ms_new;
          var last_time;
          first = 0;
          duration_ms = 0;
          progress_ms = 0;
          progress_ms_new = 0;
          last_time = 0;





          function updateprogressbar() {
            // Make an Ajax request to the server


            var oldProgressbar = document.querySelector('#progressbar');

            if (progress_ms_new - duration_ms >= 0 || Date.now() - last_time >= 10000 || first === 0) {
            $.ajax({
              url: "/tv", // Replace with the appropriate server endpoint
              method: "GET",
              success: function(response) {
                last_time = Date.now();
                // Create a temporary element to hold the response HTML
                var tempElement = document.createElement('div');
                tempElement.innerHTML = response;
                first = 1;
      
                // Extract the new image URL from the response
                
                progress_ms = parseFloat(tempElement.querySelector('#progressbar').value);
                duration_ms = parseFloat(tempElement.querySelector('#progressbar').max);
                queue = tempElement.querySelector('#stuff').innerHTML;

                oldProgressbar.max = duration_ms;
              
                tempElement = null;
              },
              error: function(xhr, status, error) {
                // Handle the error case
                console.log("Error:", error);
              }
            });
          }


          progress_ms_new = progress_ms + (Date.now() - last_time) ;
          
          console.log(progress_ms_new);
          oldProgressbar.value = progress_ms_new;

          if (progress_ms_new/1000 <= 5 || progress_ms_new >= duration_ms) {
            isFirstExecution = true;
            refreshContent()
            console.log("first")
          }



          }
      
          // Refresh the content initially
          updateprogressbar();
      
          // Refresh the content every 10 seconds
          setInterval(updateprogressbar, 400); // 10 seconds = 10,000 milliseconds
        });
      
        var htmlCode1 = `
        <tr>
          <th colspan="3">Getränke</th>
      </tr>

      <tr>
          <td>Wasser</td>
          <td>0.2 l</td>
          <td>0.50 €</td>
      </tr>
      <tr>
          <td>Cola</td>
          <td>0.2 l</td>
          <td>0.50 €</td>
      </tr>
      <tr>
          <td>Fanta</td>
          <td>0.2 l</td>
          <td>0.50 €</td>
      </tr>
      <tr>
          <td>Sprite</td>
          <td>0.2 l</td>
          <td>0.50 €</td>
      </tr>
      <tr>
          <td>Slush Eis</td>
          <td>0.2 l</td>
          <td>2.00 €</td>
      </tr>

      <tr>
          <th colspan="3">Speisen</th>
      </tr>

      <tr>
          <td>Sandwich</td>
          <td></td>
          <td>TBD</td>
      </tr>
      <tr>
          <td>Brezeln</td>
          <td></td>
          <td>1.00 €</td>
      </tr>

      <tr>
          <th colspan="3">Snacks</th>
      </tr>

      <tr>
          <td>Salzsstangen</td>
          <td>1 Becher</td>
          <td>0.50 €</td>
      </tr>
      <tr>
          <td>Nüsse</td>
          <td>1 Becher</td>
          <td>1.00 €</td>
      </tr>
      <tr>
          <td>Chips</td>
          <td>1 Tüte</td>
          <td>TBD</td>
      </tr>
      <tr>
          <td>Popcorn</td>
          <td>1 Tüte</td>
          <td>TBD</td>
      </tr>
              `;
        
              var htmlCode2 = `      <tr>
                <td>Popcorn</td>
                <td>1 Tüte</td>
                <td>TBD</td>
            </tr>`;

    // Get the content element
    var contentElement = document.getElementById('tablele');
    var heading = document.getElementById('headi');

    var testt = 0;
    // Function to toggle the HTML codes
    function toggleHTML() {
      if (testt === 0) {
        testt = 1;
        contentElement.innerHTML = htmlCode1;
        heading.textContent = "Getränke- und Speiseliste"
        console.log("somethingshouldhappem");

      } else {
        testt = 0;
        contentElement.innerHTML = queue;
        heading.textContent = "Songwünsche"
        console.log(queue);
        
        var cells = document.getElementsByTagName('p');

        // Iterate through each cell
        for (var i = 0; i < cells.length; i++) {
          var cell = cells[i];
          
          // Check if the cell content starts with "Stimmen"
          if (cell.innerHTML.trim().startsWith('Stimmen')) {
            cell.style.color = '#2ec969'; // Apply green color to the cell
            cell.style.marginBottom = "10000px";

          }
        }

      }
      contentElement.style.fontSize = "30px";
    }

    // Set the initial HTML code
    contentElement.innerHTML = htmlCode1;
    // Toggle the HTML codes every 10 seconds
    setInterval(toggleHTML, 30000);
      </script>
      
      
      
      
</body>
</html>
