<!DOCTYPE html>
<html>


<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>my tv</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='tv.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    
</head>
<body>
        <div class="container pe-0" , id="alll">

            <div class="row" style="position:absolute; width: 100%; height: 100vh">
                <div class="col-md pe-0" style="background-color: #1C1C1C">
                    <div id="foodDiv" class="container-fluid text-center">
                        <h1>Getränke- und Speiseliste</h1>

                        <table class="foodtable">

                            <tr>
                                <th colspan="3">Getränke</th>
                            </tr>

                            <tr>
                                <td>Wasser</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Cola</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Fanta</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Sprite</td>
                                <td>0.2 l</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Slush Eis</td>
                                <td>0.2 l</td>
                                <td>2.00 €</td>
                            </tr>

                            <tr>
                                <th colspan="3">Speisen</th>
                            </tr>

                            <tr>
                                <td>Sandwich</td>
                                <td></td>
                                <td>TBD</td>
                            </tr>
                            <tr>
                                <td>Brezeln</td>
                                <td></td>
                                <td>1.00 €</td>
                            </tr>

                            <tr>
                                <th colspan="3">Snacks</th>
                            </tr>

                            <tr>
                                <td>Salzsstangen</td>
                                <td>1 Becher</td>
                                <td>0.50 €</td>
                            </tr>
                            <tr>
                                <td>Nüsse</td>
                                <td>1 Becher</td>
                                <td>1.00 €</td>
                            </tr>
                            <tr>
                                <td>Chips</td>
                                <td>1 Tüte</td>
                                <td>TBD</td>
                            </tr>
                            <tr>
                                <td>Popcorn</td>
                                <td>1 Tüte</td>
                                <td>TBD</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div id="currentSongCol" class="col-md pe-0" >
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                    

                    <div id="currentSongDiv" class="container-fluid text-center">
                      <div id="gradient">
                        <img id="album-art" src="{{img}}">
                        
                        <div id="currentSong" class="container songDiv">
                          <h2 id="songname" class="scrolling-text">{{ artists }}</h2>
                          <h3 id="song-artists" class="scrolling-text">{{ songname }}</h3>
                          
                          <progress id="progressbar" value="{{progress_percent}}" max="100"></progress>
                        </div>
                        <div id="upcoming1" class="container songDiv upcoming">
                          <h2 id="upcoming1songname" class="scrolling-text">{{ upcoming[0].name }}</h2>
                          <h3 id="upcoming1artists" class="scrolling-text">{{ upcoming[0].artists }}</h3>
                        </div>
                        
                        <div id="upcoming2" class="container songDiv upcoming">
                          <h2 id="upcoming2songname" class="scrolling-text">{{ upcoming[1].name }}</h2>
                          <h3 id="upcoming2artists" class="scrolling-text">{{ upcoming[1].artists }}</h3>
                        </div>
                      </div>
                    </div>
    
                          
                </div>
            </div>
        </div>

    <script>
        var ip = "<%= ip %>";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
          var isFirstExecution = true;

          



          function refreshContent() {
            // Make an Ajax request to the server
            
            $.ajax({
              url: "/tv", // Replace with the appropriate server endpoint
              method: "GET",
              success: function(response) {
                // Create a temporary element to hold the response HTML
                var tempElement = document.createElement('div');
                tempElement.innerHTML = response;
      
                // Extract the new image URL from the response
                var newImgURL = tempElement.querySelector('#album-art').src;
                var newSongname = tempElement.querySelector('#songname').textContent;
                var newArtistname = tempElement.querySelector('#song-artists').textContent;
                var newUp1name = tempElement.querySelector('#upcoming1songname').textContent;
                var newUp1Aname = tempElement.querySelector('#upcoming1artists').textContent;
                var newUp2name = tempElement.querySelector('#upcoming2songname').textContent;
                var newUp2Aname = tempElement.querySelector('#upcoming2artists').textContent;
                var newProgress = parseFloat(tempElement.querySelector('#progressbar').value);
      
                // Get the existing image element
                var albumArtElement = document.querySelector('#album-art');
                var oldSongname = document.querySelector('#songname');
                var oldArtistname = document.querySelector('#song-artists');
                var oldUp1name = document.querySelector('#upcoming1songname');
                var oldUp1Aname = document.querySelector('#upcoming1artists');
                var oldUp2name = document.querySelector('#upcoming2songname');
                var oldUp2Aname = document.querySelector('#upcoming2artists');
                var oldProgress = document.querySelector('#progressbar');
                var currentSongCol = document.getElementById('currentSongCol')
                
                // Check if the new image URL is different from the existing one
                if (newImgURL !== albumArtElement.src || newUp1name !== oldUp1name.textContent || isFirstExecution) {
                  // Update the image URL
                  console.log("Updated:", oldUp1name.textContent);
                  albumArtElement.src = newImgURL;
                  oldSongname.textContent  = newSongname;
                  oldArtistname.textContent  = newArtistname;
                  oldUp1name.textContent  = newUp1name;
                  oldUp1Aname.textContent  = newUp1Aname;
                  oldUp1Aname.textContent  = newUp1Aname;
                  oldUp2name.textContent  = newUp2name;
                  oldUp2Aname.textContent  = newUp2Aname;
                  currentSongCol.style.backgroundImage = "url('" + newImgURL + "')"
                  isFirstExecution = false;
                }


                var scrollingTextElements = document.getElementsByClassName('scrolling-text');
                for (var i = 0; i < scrollingTextElements.length; i++) {
                  var element = scrollingTextElements[i];
                  if (element.scrollWidth > element.clientWidth) {
                    var text = element.textContent.trim();
                    var maxWidth = element.clientWidth;
                    
                    while (element.scrollWidth > maxWidth) {
                      text = text.slice(0, -1); // Remove the last character
                      element.textContent = text + '...';
                    }
                  }
                }
                
              


                
                
              

                // Clean up the temporary element
                tempElement = null;
              },
              error: function(xhr, status, error) {
                // Handle the error case
                console.log("Error:", error);
              }
            });
          }
      
          // Refresh the content initially
          refreshContent();
      
          // Refresh the content every 10 seconds
          setInterval(refreshContent, 600); // 10 seconds = 10,000 milliseconds
        
          function updateprogressbar() {
            // Make an Ajax request to the server
            $.ajax({
              url: "/tv", // Replace with the appropriate server endpoint
              method: "GET",
              success: function(response) {
                // Create a temporary element to hold the response HTML
                var tempElement = document.createElement('div');
                tempElement.innerHTML = response;
      
                // Extract the new image URL from the response

                var newProgress = parseFloat(tempElement.querySelector('#progressbar').value);
      
                // Get the existing image element

                var oldProgress = document.querySelector('#progressbar');
      
                // Check if the new image URL is different from the existing one

                oldProgress.value = newProgress;

                if (newProgress <= 20 && newProgress >= 5) {
                  refreshContent()
                  setTimeout(function() {
                  }, 4000);
                }

                // Clean up the temporary element
                tempElement = null;
              },
              error: function(xhr, status, error) {
                // Handle the error case
                console.log("Error:", error);
              }
            });
          }
      
          // Refresh the content initially
          updateprogressbar();
      
          // Refresh the content every 10 seconds
          setInterval(updateprogressbar, 400); // 10 seconds = 10,000 milliseconds
        });
    
      </script>
      
      
      
      
</body>
</html>
